<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <script src="./lib/testHelper.js"></script>
    <script src="../dist/zrender.js"></script>
    <style>
        html {
            font-family: Arial;
            font-size: 14px;
        }
        .control {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 99999;
            font-family: Arial, Helvetica, sans-serif;
            padding: 10px;
            background: #dee;
            box-shadow: 0 0 5px #888;
            font-size: 12px;
        }
        .control-block {
            float: left;
            border-left: 1px solid #ccc;
            margin-right: 10px;
            padding-left: 5px;
        }
        button {
            margin: 2px;
        }
        .storage-key {
            color: #888;
        }
        #storage-container {
            padding: 5px 0;
        }
        label {
            padding-left: 5px;
            padding-right: 5px;
        }
    </style>
</head>
<body>

    <div class="control">
        <div class="control-block">
            <div>
                <button onclick="updateToURL('updateMode', 'notReloadPage');">Update not reload page</button>
                <button onclick="updateToURL('updateMode', 'reloadPage');">Update reload page</button>
            </div>
            <div>
                <button onclick="startTextRotation();">Start textRotation</button>
                <button onclick="stopTextRotation();">Stop textRotation</button>
            </div>
            <div>
                <label>textOrigin:</label>
                <button onclick="updateToURL('textOrigin', 'center');">'center'</button>
                <button onclick="updateToURL('textOrigin', [150, 100]);">[150, 100]</button>
                <button onclick="removeToURL('textOrigin');">Remove</button>
            </div>
            <div>
                <label>textBackground:</label>
                <button onclick="updateToURL('hasBg', 1);">Add</button>
                <button onclick="removeToURL('hasBg');">Remove</button>
            </div>
            <div>
                <label>textDistance:</label>
                <button onclick="updateToURL('textDistance', 15);">15</button>
                <button onclick="updateToURL('textDistance', -20);">-20</button>
                <button onclick="removeToURL('textDistance');">Remove</button>
            </div>
        </div>
        <div class="control-block">
            <div>
                <label>textPosition:</label>
                <button onclick="updateToURL('textPosition', [10, 20]);">[10, 20]</button>
                <button onclick="updateToURL('textPosition', [-10, -20]);">[-10, -20]</button>
                <button onclick="removeToURL('textPosition');">Remove</button>
            </div>
            <div>
                <label>textPadding:</label>
                <button onclick="updateToURL('textPadding', [10, 20, 30, 40]);">[10, 20, 30, 40]</button>
                <button onclick="updateToURL('textPadding', 50);">50</button>
                <button onclick="removeToURL('textPadding');">Remove</button>
            </div>
            <div>
                <label>textAlign:</label>
                <button onclick="updateToURL('textAlign', 'left');">'left'</button>
                <button onclick="updateToURL('textAlign', 'center');">'center'</button>
                <button onclick="updateToURL('textAlign', 'right');">'right'</button>
                <button onclick="removeToURL('textAlign');">Remove</button>
            </div>
            <div>
                <label>textVerticalAlign:</label>
                <button onclick="updateToURL('textVerticalAlign', 'top');">'top'</button>
                <button onclick="updateToURL('textVerticalAlign', 'middle');">'middle'</button>
                <button onclick="updateToURL('textVerticalAlign', 'bottom');">'bottom'</button>
                <button onclick="removeToURL('textVerticalAlign');">Remove</button>
            </div>
            <div>
                <label>transformText:</label>
                <button onclick="updateToURL('transformText', true);">Enable</button>
                <button onclick="removeToURL('transformText');">Remove</button>
            </div>
        </div>
        <div class="control-block">
            STATE: <br>
            <div id="storage-container"></div>
        </div>
    </div>


    <div id="main1" style="width:1000px;height:700px;"></div>
    <div id="main2" style="width:1500px;height:2800px;margin:0;"></div>


    <script type="text/javascript">
        var clone = zrender.util.clone;
        var encodeHTML = testHelper.encodeHTML;
        var _timer;
        var _storage = {};
        var _shapes2 = [];
        var _shapes1 = [];

        function init() {
            initBase();
            testHelper.initURLStorage(updateView);
        }

        function initBase() {
            var posList = [
                'left', 'right', 'top', 'bottom',
                'inside',
                'insideTop', 'insideLeft', 'insideRight', 'insideBottom',
                'insideTopLeft', 'insideTopRight', 'insideBottomLeft', 'insideBottomRight'
            ];

            var zr1 = zrender.init(document.getElementById('main1'), {
                renderer: window.__ZRENDER__DEFAULT__RENDERER__
            });

            zrender.util.each(posList, function (textPos, idx) {
                var text = textPos;
                if (text.length < 8) {
                    text = text + text;
                }
                if (text.length > 8) {
                    text = text.substr(0, 8) + '\n' + text.substr(8, text.length - 1);
                }
                var shape = new zrender.Rect({
                    position: [(idx % 4) * 220, 150 * Math.floor(idx / 4)],
                    scale: [1, 1],
                    style: {
                        fill: 'red',
                        text: text,
                        textPosition: textPos
                    },
                    shape: {
                        x: 100,
                        y: 50,
                        width: 150,
                        height: 100
                    }
                });
                _shapes1.push(shape);
                zr1.add(shape);
            });

            var zr2 = zrender.init(document.getElementById('main2'), {
                renderer: window.__ZRENDER__DEFAULT__RENDERER__
            });

            zrender.util.each(posList, function (textPos, idx) {
                var text = textPos;

                var shape = new zrender.Rect({
                    position: [(idx % 2) * 300, 150 * Math.floor(idx / 2)],
                    style: {
                        fill: '#eeaaff',
                        text: [
                            '{j|' + text + '}',
                            '我是 Rect Text, textDistance: 20',
                            '整体的 textAlign textVerticalAlign 取默认值'
                        ].join('\n'),
                        textFill: 'red',
                        font: '10px Arial',
                        // textVerticalAlign: 'bottom',
                        // textAlign: 'right',
                        rich: {
                            j: {
                                font: '16px Arial',
                                textFill: '#922889',
                                textVerticalAlign: 'top'
                            }
                        },
                        textPosition: textPos,
                    },
                    shape: {
                        x: 220,
                        y: 100,
                        width: 260,
                        height: 100
                    }
                });
                _shapes2.push(shape);
                zr2.add(shape);
            });
        }

        window.updateToURL = function (key, value) {
            if (_storage.updateMode === 'notReloadPage' && key !== 'updateMode') {
                testHelper.updateToHash(key, clone(value));
            }
            else {
                testHelper.updateToSearch(key, clone(value));
            }
        };

        window.removeToURL = function (key) {
            // key with undefined value will be removed after JSON.stringify();
            testHelper.updateToHash(key, void 0);
            testHelper.updateToSearch(key, void 0);
            // force reload whether search is changed.
            location.reload();
        };

        function useDefault(key) {
            // Do not set attr, test the default cases.
            return !_storage.hasOwnProperty(key);
        }

        function updateView() {
            updateStorage();
            updateStorageView();
            updateTextPadding();
            updateTextOrigin();
            updateTextPosition();
            updateTextDistance();
            updateTextAlign();
            updateTextVerticalAlign();
            updateBackground();
        }

        function updateStorage() {
            _storage = testHelper.getAllFromSearch();
            var updateMode = _storage.updateMode = _storage.updateMode || 'notReloadPage';
            if (updateMode === 'notReloadPage') {
                _storage = testHelper.getAllFromHash();
            }
            _storage.updateMode = updateMode;
        }

        function updateStorageView() {
            var html = [];
            for (var key in _storage) {
                if (_storage.hasOwnProperty(key)) {
                    html.push(
                        '<span class="storage-key">' + encodeHTML(key) + '</span>:&nbsp;&nbsp;'
                        + encodeHTML(JSON.stringify(_storage[key]))
                    );
                }
            }
            var dom = document.getElementById('storage-container');
            dom.innerHTML = html.join('<br>');
        }

        window.startTextRotation = function () {
            var rotation = 0;
            window.stopTextRotation();

            _timer = setInterval(function () {
                rotation += 0.01;
                rotation %= Math.PI * 2;
                for (var i = 0; i < _shapes1.length; i++) {
                    var shape = _shapes1[i];
                    shape.attr({
                        style: {
                            textRotation: rotation
                        }
                    });
                }
                for (var i = 0; i < _shapes2.length; i++) {
                    var shape = _shapes2[i];
                    shape.attr({
                        style: {
                            textRotation: rotation
                        }
                    });
                }
            }, 20);
        };

        window.stopTextRotation = function () {
            clearInterval(_timer);
        };

        function updateTextOrigin() {
            if (useDefault('textOrigin')) {
                return;
            }
            var textOrigin = _storage.textOrigin;
            for (var i = 0; i < _shapes1.length; i++) {
                var shape = _shapes1[i];
                shape.attr({
                    style: {
                        textOrigin: clone(textOrigin)
                    }
                });
            }
            for (var i = 0; i < _shapes2.length; i++) {
                var shape = _shapes2[i];
                shape.attr({
                    style: {
                        textOrigin: clone(textOrigin)
                    }
                });
            }
        };

        function updateBackground() {
            if (useDefault('hasBg')) {
                return;
            }
            var hasBg = _storage.hasBg;
            for (var i = 0; i < _shapes1.length; i++) {
                var shape = _shapes1[i];
                shape.attr({
                    style: {
                        textBorderRadius: 3,
                        textBackgroundColor: 'rgba(0, 255, 0, 0.3)',
                        textBorderColor: '#191933',
                        textBorderWidth: 2,
                        textBoxShadowBlur: 5,
                        textBoxShadowColor: '#1099ee',
                        textBoxShadowOffsetX: 2,
                        textBoxShadowOffsetY: 5
                    }
                });
            }
            for (var i = 0; i < _shapes2.length; i++) {
                var shape = _shapes2[i];
                shape.attr({
                    style: {
                        textBorderRadius: 8,
                        textBackgroundColor: 'rgba(0, 255, 0, 0.3)',
                        textBorderColor: '#191933',
                        textBorderWidth: 2,
                        textBoxShadowBlur: 5,
                        textBoxShadowColor: '#1099ee',
                        textBoxShadowOffsetX: 2,
                        textBoxShadowOffsetY: 5
                    }
                });
            }
        };

        function updateTextDistance() {
            if (useDefault('textDistance')) {
                return;
            }
            var dist = _storage.textDistance;
            for (var i = 0; i < _shapes1.length; i++) {
                var shape = _shapes1[i];
                shape.attr({
                    style: {
                        textDistance: clone(dist)
                    }
                });
            }
            for (var i = 0; i < _shapes2.length; i++) {
                var shape = _shapes2[i];
                shape.attr({
                    style: {
                        textDistance: clone(dist)
                    }
                });
            }
        };

        function updateTextPosition() {
            if (useDefault('textPosition')) {
                return;
            }
            var textPosition = _storage.textPosition;
            for (var i = 0; i < _shapes1.length; i++) {
                var shape = _shapes1[i];
                shape.attr({
                    style: {
                        textPosition: textPosition
                    }
                });
            }
            for (var i = 0; i < _shapes2.length; i++) {
                var shape = _shapes2[i];
                shape.attr({
                    style: {
                        textPosition: textPosition
                    }
                });
            }
        };

        function updateTextPadding() {
            if (useDefault('textPadding')) {
                return;
            }
            for (var i = 0; i < _shapes1.length; i++) {
                var shape = _shapes1[i];
                shape.attr({
                    style: {
                        textPadding: clone(_storage.textPadding)
                    }
                });
            }
            for (var i = 0; i < _shapes2.length; i++) {
                var shape = _shapes2[i];
                shape.attr({
                    style: {
                        textPadding: clone(_storage.textPadding)
                    }
                });
            }
        }

        function updateTextAlign() {
            if (useDefault('textAlign')) {
                return;
            }
            var textAlign = _storage.textAlign;
            for (var i = 0; i < _shapes1.length; i++) {
                var shape = _shapes1[i];
                shape.attr({
                    style: {
                        textAlign: textAlign
                    }
                });
            }
            for (var i = 0; i < _shapes2.length; i++) {
                var shape = _shapes2[i];
                shape.attr({
                    style: {
                        textAlign: textAlign
                    }
                });
            }
        };

        function updateTextVerticalAlign(textVerticalAlign) {
            if (useDefault('textVerticalAlign')) {
                return;
            }
            var textVerticalAlign = _storage.textVerticalAlign;
            for (var i = 0; i < _shapes1.length; i++) {
                var shape = _shapes1[i];
                shape.attr({
                    style: {
                        textVerticalAlign: textVerticalAlign
                    }
                });
            }
            for (var i = 0; i < _shapes2.length; i++) {
                var shape = _shapes2[i];
                shape.attr({
                    style: {
                        textVerticalAlign: textVerticalAlign
                    }
                });
            }
        };


        init();


    </script>


</body>
</html>